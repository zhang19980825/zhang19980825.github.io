
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>认真的人，自带光芒。</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    
    <meta name="description" content="当我们在使用分库分表或者一致性缓存的问题，一定会考虑到如何将数据均匀的分散到各个节点之中，以减少数据节点的加减对数据迁移的影响，而一致性Hash算法就是来解决这个问题的。
一致性Hash算法（概念）,"> 
    <meta name="author" content="ZhangYang"> 
    
    
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
</head></html>
<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">JWT+微信登录</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class="main">
        <h1 class="title">JWT+微信登录</h1>
        <div class="stuff">
            <span>二月 15, 2019</span>
            

        </div>
        <div class="content markdown">
            <p>坑还是挺多的，就梳理下流程吧，记性不太好。。。<br>先说下JWT吧：<br>1.JWT 是一个开放标准，它定义了一种用于简洁，自包含的用于通信双方之间以 JSON 对象的形式安全传递信息的方法。<br>JWT 可以使用 HMAC 算法或者是 RSA 的公钥密钥对进行签名<br>简单来说，就是通过一定规范来生成token，然后可以通过解密算法逆向解密token，这样就可以获取用户信息</p>
<pre><code>{
     id:888,
     name:&apos;小D&apos;,
     expire:10000
 }

 funtion 加密(object, appsecret){
     xxxx
     return base64( token);
 }

 function 解密(token ,appsecret){

     xxxx
     //成功返回true,失败返回false
 }
</code></pre><p>优点：<br> 1）生产的token可以包含基本信息，比如id、用户昵称、头像等信息，避免再次查库</p>
<p>2）存储在客户端，不占用服务端的内存资源</p>
<p>缺点：<br> token是经过base64编码，所以可以解码，因此token加密前的对象不应该包含敏感信息 如用户权限，密码等<br>2、JWT格式组成 头部、负载、签名 header+payload+signature<br> 头部：主要是描述签名算法<br> 负载：主要描述是加密对象的信息，如用户的id等，也可以加些规范里面的东西，如iss签发者，exp 过期时间，sub 面向的用户<br> 签名：主要是把前面两部分进行加密，防止别人拿到token进行base解密后篡改token  </p>
<p>3、关于jwt客户端存储<br> 可以存储在cookie，localstorage和sessionStorage里面<br>上代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">import io.jsonwebtoken.Claims;</span><br><span class="line">import io.jsonwebtoken.Jwt;</span><br><span class="line">import io.jsonwebtoken.Jwts;</span><br><span class="line">import io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line">import net.xdclass.xdvideo.domain.User;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @Author: ZhangYang</span><br><span class="line"> * @Date: 2019/2/13 21:52</span><br><span class="line"> */</span><br><span class="line">public class JwtUtils &#123;</span><br><span class="line">    public static final String SUBJECT=&quot;zhangyang&quot;;</span><br><span class="line">    public static final long EXPIRE=1000*60*60*24*7;//设置过期时间为一周</span><br><span class="line">    public static final String APPSECRET=&quot;zy666&quot;;//秘钥</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 生成jwt</span><br><span class="line">     * @param user</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static String geneJsonWebToken(User user)&#123;</span><br><span class="line">        if(user==null||user.getId()==null||user.getName()==null||user.getHeadImg()==null)&#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        String token=Jwts.builder().setSubject(SUBJECT)</span><br><span class="line">                .claim(&quot;id&quot;,user.getId())</span><br><span class="line">                .claim(&quot;name&quot;,user.getName())</span><br><span class="line">                .claim(&quot;img&quot;,user.getHeadImg())</span><br><span class="line">                .setIssuedAt(new Date())</span><br><span class="line">                .setExpiration(new Date(System.currentTimeMillis()+EXPIRE))</span><br><span class="line">                .signWith(SignatureAlgorithm.HS256,APPSECRET).compact();</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 校验token</span><br><span class="line">     * @param token</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static Claims checkJWT(String token)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            final Claims claims =  Jwts.parser().setSigningKey(APPSECRET).</span><br><span class="line">                    parseClaimsJws(token).getBody();</span><br><span class="line">            return  claims;</span><br><span class="line"></span><br><span class="line">        &#125;catch(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面主要记录一下微信登录的流程及重要代码:<br><img src="http://img.027cgb.com/613363/021501.png" alt="avator"><br>详情可见：<a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419316505&amp;token=&amp;lang=zh_CN" target="_blank" rel="noopener">https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419316505&amp;token=&amp;lang=zh_CN</a><br>微信登录的相关数据配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">package net.xdclass.xdvideo.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.PropertySource;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @Author: ZhangYang</span><br><span class="line"> * @Date: 2019/2/10 15:09</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@PropertySource(value=&quot;classpath:application.properties&quot;)</span><br><span class="line">public class WechatConfig &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 公众号appid</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;$&#123;wxpay.appid&#125;&quot;)</span><br><span class="line">    private String wxpid;</span><br><span class="line">    /**</span><br><span class="line">     * 公众号秘钥</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;$&#123;wxpay.appsecret&#125;&quot;)</span><br><span class="line">    private String appsecret;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 开放平台AppId</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;$&#123;wxopen.appid&#125;&quot;)</span><br><span class="line">    private String openAppId;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 开放平台秘钥</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;$&#123;wxopen.appsecret&#125;&quot;)</span><br><span class="line">    private String openSecret;</span><br><span class="line">    /**</span><br><span class="line">     * 回调地址</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;$&#123;wxopen.redirect_url&#125;&quot;)</span><br><span class="line">    private String openRedirectUrl;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 微信开放平台二维码连接</span><br><span class="line">     */</span><br><span class="line">    private final static String OPEN_QRCODE_URL= &quot;https://open.weixin.qq.com/connect/qrconnect?appid=%s&amp;redirect_uri=%s&amp;response_type=code&amp;scope=snsapi_login&amp;state=%s#wechat_redirect&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 开放平台获取access_token地址</span><br><span class="line">     */</span><br><span class="line">    private final static String OPEN_ACCESS_TOKEN_URL=&quot;https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取用户信息</span><br><span class="line">     */</span><br><span class="line">    private final static String OPEN_USER_INFO_URL =&quot;https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s&amp;lang=zh_CN&quot;;</span><br><span class="line">    public String getWxpid() &#123;</span><br><span class="line">        return wxpid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setWxpid(String wxpid) &#123;</span><br><span class="line">        this.wxpid = wxpid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAppsecret() &#123;</span><br><span class="line">        return appsecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAppsecret(String appsecret) &#123;</span><br><span class="line">        this.appsecret = appsecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getOpenAppId() &#123;</span><br><span class="line">        return openAppId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOpenAppId(String openAppId) &#123;</span><br><span class="line">        this.openAppId = openAppId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getOpenSecret() &#123;</span><br><span class="line">        return openSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOpenSecret(String openSecret) &#123;</span><br><span class="line">        this.openSecret = openSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getOpenRedirectUrl() &#123;</span><br><span class="line">        return openRedirectUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOpenRedirectUrl(String openRedirectUrl) &#123;</span><br><span class="line">        this.openRedirectUrl = openRedirectUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String getOpenQrcodeUrl() &#123;</span><br><span class="line">        return OPEN_QRCODE_URL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String getOpenAccessTokenUrl() &#123;</span><br><span class="line">        return OPEN_ACCESS_TOKEN_URL;</span><br><span class="line">    &#125;</span><br><span class="line">    public static String getOpenUserInfoUrl() &#123;</span><br><span class="line">        return OPEN_USER_INFO_URL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第一步：微信用户请求登录第三方应用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 拼装微信扫一扫登录url</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@GetMapping(&quot;login_url&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public JsonData loginUrl(@RequestParam(value = &quot;access_page&quot;,required = true)String accessPage)throws UnsupportedEncodingException &#123;</span><br><span class="line">    String redirectUrl=wechatConfig.getOpenRedirectUrl();</span><br><span class="line"></span><br><span class="line">    String callbackUrl=URLEncoder.encode(redirectUrl,&quot;GBK&quot;);</span><br><span class="line"></span><br><span class="line">    String qrcodeUrl = String.format(wechatConfig.getOpenQrcodeUrl(),wechatConfig.getOpenAppId(),callbackUrl,accessPage);</span><br><span class="line"></span><br><span class="line">    return JsonData.buildSuccess(qrcodeUrl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这一步主要是拼装扫一扫登录的URL：微信公众平台给我们提供了这个地址，我们只需要改变其中的三个参数即可:appid(公众号appid)，callbackUrl（回调地址–开放平台申请成功后一个网址会对应一个回调地址），accessPage（我自己理解的就是前端传入的真正要访问的网站地址），然后把包含二维码链接的地址封装成json数据返回给前端<br>2.用户通过扫描二维码请求微信授权登录<br>3.微信开放平台请求用户登录确认<br>4.用户确认<br>5.微信开放平台收到用户确认之后，会有一个重定向的url，就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wxopen.redirect_url=http://xdclasstest.ngrok.xiaomiqiu.cn/api/v1/wechat/user/callback</span><br></pre></td></tr></table></figure></p>
<p>这个URL是通过回调地址和回调的controller方法的路径组成的，就是/api/v1/wechat/user/callback来处理回调之后的相关问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 微信扫码登录回调地址</span><br><span class="line">     * @param code</span><br><span class="line">     * @param state</span><br><span class="line">     * @param response</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(&quot;/user/callback&quot;)</span><br><span class="line">    public void wechatUserCallback(@RequestParam(value = &quot;code&quot;,required = true) String code,</span><br><span class="line">                                   String state, HttpServletResponse response)throws IOException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        User user = userService.saveWeChatUser(code);</span><br><span class="line">        if(user!= null)&#123;</span><br><span class="line">            //生成jwt</span><br><span class="line">            String token=JwtUtils.geneJsonWebToken(user);</span><br><span class="line">            // state 当前用户的页面地址，需要拼接 http://  这样才不会站内跳转</span><br><span class="line">            response.sendRedirect(state+&quot;?token=&quot;+token+&quot;&amp;head_img=&quot;+user.getHeadImg()+&quot;&amp;name=&quot;+URLEncoder.encode(user.getName(),&quot;UTF-8&quot;));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>下面贴下userService.saveWeChatUser(code)里面的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">package net.xdclass.xdvideo.service.impl;</span><br><span class="line"></span><br><span class="line">import net.xdclass.xdvideo.config.WechatConfig;</span><br><span class="line">import net.xdclass.xdvideo.domain.User;</span><br><span class="line">import net.xdclass.xdvideo.mapper.UserMapper;</span><br><span class="line">import net.xdclass.xdvideo.service.UserService;</span><br><span class="line">import net.xdclass.xdvideo.utils.HttpUtils;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.io.UnsupportedEncodingException;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @Author: ZhangYang</span><br><span class="line"> * @Date: 2019/2/14 15:30</span><br><span class="line"> */</span><br><span class="line">@Service</span><br><span class="line">public class UserServiceImpl implements UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private WechatConfig weChatConfig;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public User saveWeChatUser(String code) &#123;</span><br><span class="line">        String accessTokenUrl = String.format(WechatConfig.getOpenAccessTokenUrl(),weChatConfig.getOpenAppId(),weChatConfig.getOpenSecret(),code);</span><br><span class="line"></span><br><span class="line">        //获取access_token</span><br><span class="line">        Map&lt;String ,Object&gt; baseMap =  HttpUtils.doGet(accessTokenUrl);</span><br><span class="line"></span><br><span class="line">        if(baseMap == null || baseMap.isEmpty())&#123; return  null; &#125;</span><br><span class="line">        System.out.println(baseMap.get(&quot;access_token&quot;));</span><br><span class="line">        String accessToken = (String)baseMap.get(&quot;access_token&quot;);</span><br><span class="line">        String openId  = (String) baseMap.get(&quot;openid&quot;);</span><br><span class="line"></span><br><span class="line">        User dbUser=userMapper.findByopenid(openId);</span><br><span class="line">        if(dbUser!=null) &#123; //更新用户，直接返回</span><br><span class="line">            return dbUser;</span><br><span class="line">        &#125;</span><br><span class="line">        //获取用户基本信息</span><br><span class="line">        String userInfoUrl = String.format(WechatConfig.getOpenUserInfoUrl(),accessToken,openId);</span><br><span class="line">        //获取access_token</span><br><span class="line">        Map&lt;String ,Object&gt; baseUserMap =  HttpUtils.doGet(userInfoUrl);</span><br><span class="line"></span><br><span class="line">        if(baseUserMap == null || baseUserMap.isEmpty())&#123; return  null; &#125;</span><br><span class="line">        String nickname = (String)baseUserMap.get(&quot;nickname&quot;);</span><br><span class="line"></span><br><span class="line">        Double sexTemp  = (Double) baseUserMap.get(&quot;sex&quot;);</span><br><span class="line">        int sex = sexTemp.intValue();</span><br><span class="line">        String province = (String)baseUserMap.get(&quot;province&quot;);</span><br><span class="line">        String city = (String)baseUserMap.get(&quot;city&quot;);</span><br><span class="line">        String country = (String)baseUserMap.get(&quot;country&quot;);</span><br><span class="line">        String headimgurl = (String)baseUserMap.get(&quot;headimgurl&quot;);</span><br><span class="line">        StringBuilder sb = new StringBuilder(country).append(&quot;||&quot;).append(province).append(&quot;||&quot;).append(city);</span><br><span class="line">        String finalAddress = sb.toString();</span><br><span class="line">        try &#123;</span><br><span class="line">            //解决乱码</span><br><span class="line">            nickname = new String(nickname.getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);</span><br><span class="line">            finalAddress = new String(finalAddress.getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">        &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User user = new User();</span><br><span class="line">        user.setName(nickname);</span><br><span class="line">        user.setHeadImg(headimgurl);</span><br><span class="line">        user.setCity(finalAddress);</span><br><span class="line">        user.setOpenid(openId);</span><br><span class="line">        user.setSex(sex);</span><br><span class="line">        user.setCreateTime(new Date());</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        return user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>6.用户点击确认登录之后会执行上述代码，首先微信公众平台收到用户确认之后他会拉起第三方应用并生成一个code，这样的话那个controller的回调地址就肯定接收到了这个code，下来他会进行token_url的拼接即<a href="https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code" target="_blank" rel="noopener">https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code</a><br>需要appid，secret（秘钥），code（获取到的）三个参数，然后发一个http的get请求，当然代码中的HttpUtils是提前封装好的，发完请求之后就拿到了token，为了防止用户一些用户名或者其他信息的更给，先进行一下判断,进行用户数据的更新，由于微信开放平台给我们提供了获取用户信息的url即<a href="https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s&amp;lang=zh_CN这里需要token和openid两个参数,然后利用这个地址返送HttpGet请求获取用户的和数据库有的对应的信息并存入数据库，并把这个user对象返回，返回的目的是为了用JWT来生成JwtToken,下来进行页面重定向。" target="_blank" rel="noopener">https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s&amp;lang=zh_CN这里需要token和openid两个参数,然后利用这个地址返送HttpGet请求获取用户的和数据库有的对应的信息并存入数据库，并把这个user对象返回，返回的目的是为了用JWT来生成JwtToken,下来进行页面重定向。</a>  </p>
<p>这个时候说一下JWT吧。上代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package net.xdclass.xdvideo.interceoter;</span><br><span class="line"></span><br><span class="line">import com.google.gson.Gson;</span><br><span class="line">import io.jsonwebtoken.Claims;</span><br><span class="line">import net.xdclass.xdvideo.domain.JsonData;</span><br><span class="line">import net.xdclass.xdvideo.utils.JwtUtils;</span><br><span class="line">import org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @Author: ZhangYang</span><br><span class="line"> * @Date: 2019/2/15 11:15</span><br><span class="line"> */</span><br><span class="line">public class LoginInterceoter implements HandlerInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    private static final Gson gson=new Gson();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 进入controller之前进行拦截</span><br><span class="line">     * @param request</span><br><span class="line">     * @param response</span><br><span class="line">     * @param handler</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        String token=request.getHeader(&quot;token&quot;);</span><br><span class="line">        if(token==null)&#123;</span><br><span class="line">            token=request.getParameter(&quot;token&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(token!=null)&#123;</span><br><span class="line">            Claims claims=JwtUtils.checkJWT(token);</span><br><span class="line">            if(claims!=null)&#123;</span><br><span class="line">                Integer userId=(Integer)claims.get(&quot;id&quot;);</span><br><span class="line">                String name = (String) claims.get(&quot;name&quot;);</span><br><span class="line"></span><br><span class="line">                request.setAttribute(&quot;user_id&quot;,userId);</span><br><span class="line">                request.setAttribute(&quot;name&quot;,name);</span><br><span class="line"></span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sendJsonMessage(response,JsonData.buildError(&quot;请登录&quot;));</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 响应数据给前端</span><br><span class="line">     * @param response</span><br><span class="line">     * @param obj</span><br><span class="line">     */</span><br><span class="line">    public static void sendJsonMessage(HttpServletResponse response, Object obj) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        response.setContentType(&quot;application/json; charset=utf-8&quot;);</span><br><span class="line">        PrintWriter writer = response.getWriter();</span><br><span class="line">        writer.print(gson.toJson(obj));</span><br><span class="line">        writer.close();</span><br><span class="line"></span><br><span class="line">        response.flushBuffer();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 拦截器配置</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class IntercepterConfig implements WebMvcConfigurer &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void addInterceptors(InterceptorRegistry registry) &#123;</span><br><span class="line"></span><br><span class="line">        registry.addInterceptor(new LoginInterceoter()).addPathPatterns(&quot;/user/api/v1/*/**&quot;);</span><br><span class="line">        WebMvcConfigurer.super.addInterceptors(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个主要还是那个防止不登录就直接下单的那种情况，因为他拿不到JWT的token或者他解不了token就说明没有登录</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                </ul>
            
        </div>
        

    </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>